{% extends 'extends/base.html' %}

{% block title %}Entity Account List{% endblock title %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between mb-3">
        <h4>Entity Account List</h4>
        <a href="{% url 'entity_account_create' %}" class="btn btn-primary">Add</a>
    </div>

    <table id="entityTable" class="table table-bordered table-striped">
        <thead>
            <tr>
                <th data-col="0">ID</th>
                <th data-col="1">Entity ID</th>
                <th data-col="2">Entity Type</th>
                <th data-col="3">PI Number</th>
                <th data-col="4">PI Issue Date</th>
                <th data-col="5">PI Expiry Date</th>
                <th data-col="6">English Name</th>
                <th data-col="7">Arabic Name</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for entity in entity_accounts %}
            <tr class="clickable-row" data-id="{{ entity.id }}">
                <td>{{ entity.id }}</td>
                <td>{{ entity.entity_id }}</td>
                <td>{{ entity.get_entity_type_display }}</td>
                <td>{{ entity.primary_identifier_number }}</td>
                <td>{{ entity.primary_identifier_issue_date|date:"d-M-Y" }}</td>
                <td>{{ entity.primary_identifier_expiry_date|date:"d-M-Y" }}</td>
                <td>{{ entity.english_name }}</td>
                <td>{{ entity.arabic_name|default:"-" }}</td>
                <td>
                    <!-- CORRECT - use entity_account_edit for editing -->
                    <a href="{% url 'entity_account_edit' entity.id %}" class="btn btn-sm btn-warning edit-btn">
                        Edit
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center">No records found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Column Dropdown Menu -->
<div id="columnMenu" class="dropdown-menu p-3 shadow" style="position:absolute; display:none; z-index:9999; width:220px;">
    <input type="text" id="colSearch" class="form-control mb-2" placeholder="Search">
    <button class="btn btn-sm btn-outline-primary w-100 mb-1" id="sortAsc">Sort Ascending</button>
    <button class="btn btn-sm btn-outline-primary w-100 mb-1" id="sortDesc">Sort Descending</button>
    <button class="btn btn-sm btn-outline-secondary w-100" id="hideCol">Hide Column</button>
</div>

<!-- Detail Drawer -->
<div id="detailDrawer" class="detail-drawer">
    <div id="drawerContent">
        <!-- Content loaded dynamically -->
    </div>
</div>

<!-- Overlay -->
<div id="drawerOverlay" class="drawer-overlay" onclick="closeDrawer()"></div>
{% endblock %}

{% block js %}
<script>
let table;
let selectedColumn = null;
let currentEntityId = null;
let entityIds = [];

const DRAWER_URL = "{% url 'entity_account_drawer' 0 %}";
const COMMENT_URL = "{% url 'entity_account_comment' 0 %}";

$(document).ready(function() {
    // Collect all entity IDs
    $('.clickable-row').each(function() {
        entityIds.push(parseInt($(this).data('id')));
    });

    // Initialize DataTable
    table = $('#entityTable').DataTable({
        paging: false,
        searching: false,
        ordering: true,
        info: false
    });

    // Disable DataTables header click
    $('#entityTable thead th').off('click.DT');

    // Prevent edit button from opening drawer
    $('#entityTable tbody').on('click', '.edit-btn', function(e) {
        e.stopPropagation();
    });

    // Open drawer on row click
    $('#entityTable tbody').on('click', 'tr.clickable-row', function() {
        const entityId = $(this).data('id');
        openDrawer(entityId);
        highlightRow(entityId);
    });

    // Column menu handlers
    $('#entityTable thead th[data-col]').on('click', function(e) {
        e.stopPropagation();
        selectedColumn = $(this).data('col');
        $('#columnMenu').css({
            top: e.pageY + 5,
            left: e.pageX + 5
        }).show();
        $('#colSearch').val('');
    });

    $(document).on('click', function() {
        $('#columnMenu').hide();
    });

    $('#colSearch').on('keyup', function() {
        table.column(selectedColumn).search(this.value).draw();
    });

    $('#sortAsc').on('click', function() {
        table.order([selectedColumn, 'asc']).draw();
    });

    $('#sortDesc').on('click', function() {
        table.order([selectedColumn, 'desc']).draw();
    });

    $('#hideCol').on('click', function() {
        table.column(selectedColumn).visible(false);
        $('#columnMenu').hide();
    });
});

function openDrawer(entityId) {
    currentEntityId = parseInt(entityId);
    const url = DRAWER_URL.replace('0', entityId);
    
    $('#drawerContent').html('<div class="text-center p-4"><div class="spinner-border text-primary" role="status"></div></div>');
    $('#detailDrawer').addClass('open');
    $('#drawerOverlay').addClass('show');
    $('body').addClass('drawer-open');

    $.get(url, function(html) {
        $('#drawerContent').html(html);
    }).fail(function() {
        $('#drawerContent').html('<div class="alert alert-danger m-3">Failed to load details</div>');
    });
}

function closeDrawer() {
    $('#detailDrawer').removeClass('open');
    $('#drawerOverlay').removeClass('show');
    $('body').removeClass('drawer-open');
    currentEntityId = null;
    $('.clickable-row').removeClass('table-primary');
}

function navigateDrawer(direction) {
    if (!currentEntityId) return;
    
    const currentIndex = entityIds.indexOf(currentEntityId);
    const newIndex = currentIndex + direction;
    
    if (newIndex >= 0 && newIndex < entityIds.length) {
        const newId = entityIds[newIndex];
        openDrawer(newId);
        highlightRow(newId);
        
        // Scroll row into view if needed
        const $row = $(`tr[data-id="${newId}"]`);
        $row[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function highlightRow(entityId) {
    $('.clickable-row').removeClass('table-primary');
    $(`tr[data-id="${entityId}"]`).addClass('table-primary');
}

function toggleReplyForm(commentId) {
    $(`#replyForm-${commentId}`).toggle();
}

function submitComment(event, entityId) {
    event.preventDefault();
    const $form = $(event.target);
    const url = COMMENT_URL.replace('0', entityId);
    
    $.post(url, $form.serialize(), function(html) {
        $('#noComments').remove();
        $('#commentsList').append(html);
        $form[0].reset();
    }).fail(function(xhr) {
        alert(xhr.responseJSON?.error || 'Failed to add comment');
    });
    
    return false;
}

function submitReply(event, parentId, entityId) {
    event.preventDefault();
    const $form = $(event.target);
    const url = COMMENT_URL.replace('0', entityId);
    
    $.post(url, $form.serialize(), function(html) {
        // Reload the drawer to show the new reply properly nested
        openDrawer(entityId);
    }).fail(function(xhr) {
        alert(xhr.responseJSON?.error || 'Failed to add reply');
    });
    
    return false;
}

function deleteEntity(entityId) {
    if (confirm('Are you sure you want to delete this entity?')) {
        // Implement delete logic or redirect to delete view
        window.location.href = `/entity-account/${entityId}/delete/`;
    }
}

// Keyboard navigation
$(document).keydown(function(e) {
    if (!currentEntityId) return;
    
    if (e.key === 'Escape') {
        closeDrawer();
    } else if (e.key === 'ArrowLeft') {
        navigateDrawer(-1);
    } else if (e.key === 'ArrowRight') {
        navigateDrawer(1);
    }
});
</script>
{% endblock js %}